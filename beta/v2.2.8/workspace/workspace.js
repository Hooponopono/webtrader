define(["exports","text!./workspace-menu.html","text!./workspace.html","../common/rivetsExtra","jquery","../websockets/binary_websockets","../windows/windows","../windows/tracker","jquery-growl","css!./workspace-menu.css","css!./workspace.css"],function(e,a,t,r,o,n,s,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.tileDialogs=e.events=e.addDialog=e.init=void 0;var l=w(a),c=w(t),d=w(r),v=w(o),u=w(n),p=w(s),f=w(i);function w(e){return e&&e.__esModule?e:{default:e}}var m;(m=local_storage.get("states"))&&!m.name&&(m.name="my-workspace-1",local_storage.set("states",m));var g=function(e){return JSON.parse(JSON.stringify(e))},k={route:"active",closeAll:function(){return(0,v.default)(".webtrader-dialog").dialog("close")},workspaces:local_storage.get("workspaces")||[],dialogs:[],update_route:function(e){return k.route=e},tileDialogs:function(){return O()},workspace:{remove:function(e){var a=k.workspaces.indexOf(e);-1!==a&&k.workspaces.splice(a,1),local_storage.set("workspaces",k.workspaces)},show:function(e){var a=e.tradeDialog&&e.tradeDialog.length;!(a=a||e.portfolio||e.statement||e.profitTable||e.deposit||e.withdraw)||u.default.is_authenticated()?(k.closeAll(),h.dialog("close"),_.delay(function(){k.current_workspace.name=e.name,local_storage.set("states",e),f.default.reopen(g(e))},500)):v.default.growl.notice({message:"Please log in to see your saved workspace.".i18n()})},perv_name:"",save_name:function(e){return k.workspace.perv_name=e.name},blur:function(e){return e.blur()},rename:function(a){var e=k.workspace.perv_name,t=k.current_workspace;if((!a.name||2<=k.workspaces.filter(function(e){return e.name===a.name}).length)&&(a.name=k.workspace.perv_name),local_storage.set("workspaces",k.workspaces),t.name===e){t.name=a.name;var r=local_storage.get("states");r.name=a.name,local_storage.set("states",r)}}},current_workspace:{name:(local_storage.get("states")||{}).name||"workspace-1",name_perv_value:"",is_saved:function(){return-1!==_.findIndex(k.workspaces,{name:k.current_workspace.name})},save:function(){var e=k.current_workspace,a=e.name;if(!(0,e.is_saved)())return k.saveas.show();var t=local_storage.get("states");t.name=a;var r=_.findIndex(k.workspaces,{name:t.name});k.workspaces[r]=t,k.workspaces=g(k.workspaces),local_storage.set("workspaces",k.workspaces),v.default.growl.notice({message:"Workspace changes saved".i18n()})}},rename:{show:function(){k.current_workspace.name_perv_value=k.current_workspace.name,k.route="rename"},apply:function(){var e=k.current_workspace,a=e.name,t=e.name_perv_value;if(!a||a===t)return k.rename.cancel();if(_.find(k.workspaces,{name:a})){var r=a.match(/\d+$/),o=r?parseInt(r[0]):0;for(a=a.replace(/\d+$/,"");_.find(k.workspaces,{name:a+o});)o+=1;a+=o}var n=_.find(k.workspaces,{name:t});n&&(n.name=a,k.workspaces=k.workspaces,local_storage.set("workspaces",k.workspaces));var s=local_storage.get("states");s.name=a,local_storage.set("states",s),k.current_workspace.name=a,k.route="active"},cancel:function(){k.current_workspace.name=k.current_workspace.name_perv_value,k.route="active"}},saveas:{show:function(){"saveas"!==k.route?(k.current_workspace.name_perv_value=k.current_workspace.name,k.route="saveas"):k.route="active"},apply:function(){var e=k.current_workspace,a=e.name;e.name_perv_value;if(!a)return k.saveas.cancel();if(_.find(k.workspaces,{name:a})){var t=a.match(/\d+$/),r=t?parseInt(t[0]):0;for(a=a.replace(/\d+$/,"");_.find(k.workspaces,{name:a+r});)r+=1;a+=r}var o=local_storage.get("states");o.name=a,k.workspaces.push(o),local_storage.set("workspaces",k.workspaces),k.current_workspace.name=a,k.route="active",v.default.growl.notice({message:"Added new workspace %".i18n().replace("%","<b>"+a+"</b>")})},cancel:function(){return k.rename.cancel()}},file:{hash_code:function(e){return JSON.stringify(e).split("").reduce(function(e,a){return(e=(e<<5)-e+a.charCodeAt(0))&e},0)},open_selector:function(e){(0,v.default)(e.target).closest(".workspace-manager-dialog").find("input[type=file]").click()},upload:function(e){var a=e.target.files[0];if(e.target.value=null,a){var t=new FileReader;t.onload=function(e){var a=e.target.result,t=null;try{var r=(t=JSON.parse(a)).random;if(delete t.random,r!==k.file.hash_code(t))throw"Invalid JSON file".i18n();if("workspace-template"!==t.template_type)throw"Invalid template type.".i18n()}catch(e){return void v.default.growl.error({message:e})}if(_.find(k.workspaces,{name:t.name})){name.match(/\d+$/);v.default.growl.error({message:"Template name already exists".i18n()})}else delete t.template_type,delete t.random,k.workspaces.push(t),local_storage.set("workspaces",k.workspaces),k.workspace.show(t),v.default.growl.notice({message:"Successfully added workspace as ".i18n()+"<b>"+t.name+"</b>"})},t.readAsText(a)}},download:function(e){var a=e.name,t=_.findIndex(k.workspaces,{name:a}),r=-1!==t?k.workspaces[t]:local_storage.get("states");r.name=a,r.template_type="workspace-template",r.random=k.file.hash_code(r);var o=JSON.stringify(r);downloadFileInBrowser(r.name+".json","text/json;charset=utf-8;",o),v.default.growl.notice({message:"Downloading workspace as %1".i18n().replace("%1","<b>"+r.name+".json</b>")})}}};k.current_workspace.root=k;var h=null,b=null,y=e.init=function(e){var a={closeAll:function(){return(0,v.default)(".webtrader-dialog").dialog("close")},tileDialogs:function(){return O()},showWorkspaceManager:function(){var e;e=(0,v.default)(c.default).i18n(),h=p.default.createBlankWindow(e,{title:"Manage".i18n(),width:400,height:250,resizable:!1,collapsable:!1,minimizable:!1,maximizable:!1,draggable:!1,modal:!0,close:function(){b&&b.unbind(),b=null,h&&h.destroy(),h=null},ignoreTileAction:!0,"data-authorized":!0,create:function(){return(0,v.default)("body").css({overflow:"hidden"})},beforeClose:function(){return(0,v.default)("body").css({overflow:"inherit"})}}),b=d.default.bind(e[0],k),h.dialog("open")}},t=(0,v.default)(l.default);e.append(t),d.default.bind(t[0],a)},x=e.addDialog=function(e,a,t){var r={name:e,click:function(){h&&h.dialog("close"),a()},remove:function(){o(),t()}},o=function(){var e=k.dialogs.indexOf(r);-1!==e&&k.dialogs.splice(e,1)};return k.dialogs.push(r),o},D=e.events=(0,v.default)("<div/>"),O=function(){for(var e=(0,v.default)(".webtrader-dialog").filter(function(e,a){var t=(0,v.default)(a);return t.hasClass("ui-dialog-content")&&t.dialog("isOpen")&&!t.hasClass("ui-dialog-minimized")&&(0,v.default)(window).width()>=t.dialog("option","width")}),a=function(e,a){var t=0,r=(0,v.default)(window).width(),o=115;(0,v.default)("#msg-notification").is(":visible")&&(o=150);for(var n=0;n<e.length;){for(var s=n,i=0,l=0;n!=e.length;){var c=(0,v.default)(e[n]),d=c.dialog("option","width"),u=c.dialog("option","height");if(i=Math.max(i,u),!(l+d<=r))break;l+=d,++n}var p=l<r?r-l:0,f=l<r?(r-l)/(n-s+1):0;n!=e.length&&(t+=p),0===l&&(0,v.default)(e[n]).dialog("option","width")>r&&(++n,f=0),l=0;for(var w=s;w<n;++w){l+=f;var m=(0,v.default)(e[w]),g=m.dialog("option","width");m.dialog("option","height");a&&m.dialog("widget").animate({left:l+"px",top:o+"px"},1500,m.trigger.bind(m,"animated")),m.dialog("option","position",{my:l,at:o}),l+=g}o+=i+20}return t},t=null,r=1e6,o=0;o<100;++o){var n=a(e,!1);n<r&&(t=e.slice(),r=n)}var s=(0,v.default)(".webtrader-dialog").filter(function(e,a){var t=(0,v.default)(a);return t.hasClass("ui-dialog-content")&&t.dialog("isOpen")&&!t.hasClass("ui-dialog-minimized")&&(0,v.default)(window).width()<t.dialog("option","width")});_(s).forEach(function(e){t.push(e)}),a(t,!0),setTimeout(function(){return D.trigger("tile")},1600)};e.tileDialogs=O,e.default={init:y,addDialog:x,events:D,tileDialogs:O}});