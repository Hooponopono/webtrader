define(["exports","jquery","../windows/windows","../websockets/binary_websockets","common/rivetsExtra","../common/marketUtils","jquery-growl","css!./assetIndex.css"],function(a,b,c,d,e,f){"use strict";function g(a){return a&&a.__esModule?a:{"default":a}}function h(a){if(Array.isArray(a)){for(var b=0,c=Array(a.length);b<a.length;b++)c[b]=a[b];return c}return Array.from(a)}Object.defineProperty(a,"__esModule",{value:!0}),a.init=void 0;var i=g(b),j=g(c),k=g(d),l=g(e),m=null,n=null,o=null,p=null,q=a.init=function(a){a.click(function(){n?n.moveToTop():(n=j["default"].createBlankWindow(i["default"]("<div/>"),{title:"Asset Index".i18n(),dialogClass:"assetIndex",minWidth:800,minHeight:400}),n.track({module_id:"assetIndex",is_unique:!0,data:null}),n.dialog("open"),require(["text!assetindex/assetIndex.html"],u))})},r={dropdown:{display_markets:null,display_submarkets:null,is_volatility:!1,sorted_markets:null,market_submarkets:null,selected_market:null},table:{asset_data:[],asset_data_extract:[],display_headers:[],display_asset_data:[],search_input:""},search:function(){function a(a){var b=r.table.search_input.toLowerCase();return-1!==a[0].toLowerCase().indexOf(b.toLowerCase())}return function(){r.table.display_asset_data=[],r.table.display_asset_data=r.table.asset_data_extract.filter(a),r.dropdown.is_volatility=s(r.dropdown.selected_market,r.dropdown.display_markets)}()}},s=function(a,b){var c=b[0][3]?b[0][3].innerText:b[0][0].innerText,d=-1!==a.indexOf(c);return d},t=function(){function a(a){function b(a,b){function c(a){var b=[];return a.forEach(function(a){var c=new Array(r.table.display_headers.length+1);a.forEach(function(a){if(Array.isArray(a)){var b=a[0],d=a[1],e=r.table.display_headers.indexOf(b)+1;c[e]=d}else c[0]=a}),b.push(c)}),b}function d(a){for(var b=r.table.display_headers.length,c=function(b){a.forEach(function(a){(!a[b]||Array.isArray(a[b]))&&(a[b]="-")})},d=0;b>=d;d++)c(d);return a}var e=[].concat(h(r.dropdown.market_submarkets[a][b]));r.dropdown.selected_market=a,r.dropdown.is_volatility=s(a,r.dropdown.display_markets);var f=r.table.asset_data.filter(function(a){return e.indexOf(a[1])>-1}).map(function(a){var b=[],c=a[1],d=a[2];return r.table.display_headers=[],b.push(c),d.forEach(function(a){var c=a[1],d=a[2],e=a[3];r.table.display_headers.push(c),b.push([c,d+" - "+e])}),b});f=c(f),f=d(f),r.table.display_asset_data=f,r.table.asset_data_extract=f}function c(a){var c=r.dropdown.sorted_markets;r.dropdown.display_markets?r.dropdown.display_markets.update_list(c):(r.dropdown.display_markets=j["default"].makeSelectmenu(i["default"]("<select />").insertAfter(n),{list:c,inx:0,changed:function(c){var d=Object.keys(a[c]);r.dropdown.display_submarkets.update_list(d),b(r.dropdown.display_markets.val(),r.dropdown.display_submarkets.val())},width:"180px"}),r.dropdown.display_markets.selectmenu("widget").addClass("asset-index-selectmenu"))}function d(a){r.dropdown.display_submarkets?r.dropdown.display_submarkets.update_list(Object.keys(a[r.dropdown.display_markets.val()])):(r.dropdown.display_submarkets=j["default"].makeSelectmenu(i["default"]("<select />").insertAfter(n),{list:Object.keys(a[r.dropdown.display_markets.val()]),inx:0,changed:function(){b(r.dropdown.display_markets.val(),r.dropdown.display_submarkets.val())},width:"200px"}),r.dropdown.display_submarkets.selectmenu("widget").addClass("asset-index-selectmenu"))}var e=local_storage.get("active_symbols"),g=[].concat(h(a[0].asset_index));i["default"].isEmptyObject(e)&&i["default"].isEmptyObject(g)||(r.dropdown.market_submarkets=f.getMarketsSubmarkets(e),r.dropdown.sorted_markets=f.getOrderedMarkets(e),r.table.asset_data=g,o=n.parent().find(".ui-dialog-title").addClass("with-content"),p=n.parent().find(".ui-dialog-titlebar-buttonpane"),c(r.dropdown.market_submarkets),d(r.dropdown.market_submarkets),b(r.dropdown.display_markets.val(),r.dropdown.display_submarkets.val()))}function b(){var a=i["default"]("#"+m.attr("id")+"_processing").show(),b={asset_index:1};return Promise.all([k["default"].cached.send(b)]).then(function(b){return a.hide(),Promise.resolve(b)})["catch"](function(b){return a.hide(),Promise.reject(b)})}b().then(function(b){a(b)})["catch"](function(a){i["default"].growl.error({message:a.message})})},u=function(a){a=i["default"](a).i18n(),m=a.filter("table"),a.appendTo(n),l["default"].bind(a[0],r),t(),require(["websockets/binary_websockets"],function(a){a.events.on("login",t),a.events.on("logout",t)})};a["default"]={init:q}});