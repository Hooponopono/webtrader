define(["exports","jquery","../windows/windows","../websockets/binary_websockets","common/rivetsExtra","../common/marketUtils","jquery-growl","css!./assetIndex.css"],function(e,t,a,s,r,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.init=void 0;var o=u(t),l=u(a),d=u(s),n=u(r);function u(e){return e&&e.__esModule?e:{default:e}}function p(e){if(Array.isArray(e)){for(var t=0,a=Array(e.length);t<e.length;t++)a[t]=e[t];return a}return Array.from(e)}var c=null,_=null,m=e.init=function(e){e.click(function(){_?_.moveToTop():((_=l.default.createBlankWindow((0,o.default)("<div/>"),{title:"Asset Index".i18n(),dialogClass:"assetIndex",minWidth:800,minHeight:400})).track({module_id:"assetIndex",is_unique:!0,data:null}),_.dialog("open"),require(["text!assetindex/assetIndex.html"],w))})},f={dropdown:{display_markets:null,display_submarkets:null,is_volatility:!1,sorted_markets:null,market_submarkets:null,selected_market:null},table:{asset_data:[],asset_data_extract:[],display_headers:[],display_asset_data:[],search_input:""},search:function(e){function t(e){var t=f.table.search_input.toLowerCase();return-1!==e[0].toLowerCase().indexOf(t.toLowerCase())}return f.table.display_asset_data=[],f.table.display_asset_data=f.table.asset_data_extract.filter(t),void(f.dropdown.is_volatility=y(f.dropdown.selected_market,f.dropdown.display_markets))}},y=function(e,t){var a=t[0][3]?t[0][3].innerText:t[0][0].innerText;return-1!==e.indexOf(a)},k=function(){var t;(t=(0,o.default)("#"+c.attr("id")+"_processing").show(),Promise.all([d.default.cached.send({asset_index:1})]).then(function(e){return t.hide(),Promise.resolve(e)}).catch(function(e){return t.hide(),Promise.reject(e)})).then(function(e){!function(e){var t=local_storage.get("active_symbols"),a=[].concat(p(e[0].asset_index));if(o.default.isEmptyObject(t)&&o.default.isEmptyObject(a))return;function s(e,t){var a=[].concat(p(f.dropdown.market_submarkets[e][t]));f.dropdown.selected_market=e,f.dropdown.is_volatility=y(e,f.dropdown.display_markets);var s,r=f.table.asset_data.filter(function(e){return-1<a.indexOf(e[1])}).map(function(e){var r=[],t=e[1],a=e[2];return f.table.display_headers=[],r.push(t),a.forEach(function(e){var t=e[1],a=e[2],s=e[3];f.table.display_headers.push(t),r.push([t,a+" - "+s])}),r});s=[],r.forEach(function(e){var r=new Array(f.table.display_headers.length+1);e.forEach(function(e){if(Array.isArray(e)){var t=e[0],a=e[1],s=f.table.display_headers.indexOf(t)+1;r[s]=a}else r[0]=e}),s.push(r)}),r=function(e){for(var t=f.table.display_headers.length,a=function(t){e.forEach(function(e){e[t]&&!Array.isArray(e[t])||(e[t]="-")})},s=0;s<=t;s++)a(s);return e}(r=s),f.table.display_asset_data=r,f.table.asset_data_extract=r}f.dropdown.market_submarkets=(0,i.getMarketsSubmarkets)(t),f.dropdown.sorted_markets=(0,i.getOrderedMarkets)(t),f.table.asset_data=a,_.parent().find(".ui-dialog-title").addClass("with-content"),_.parent().find(".ui-dialog-titlebar-buttonpane"),d=f.dropdown.market_submarkets,n=f.dropdown.sorted_markets,f.dropdown.display_markets?f.dropdown.display_markets.update_list(n):(f.dropdown.display_markets=l.default.makeSelectmenu((0,o.default)("<select />").insertAfter(_),{list:n,inx:0,changed:function(e){var t=Object.keys(d[e]);f.dropdown.display_submarkets.update_list(t),s(f.dropdown.display_markets.val(),f.dropdown.display_submarkets.val())},width:"180px"}),f.dropdown.display_markets.selectmenu("widget").addClass("asset-index-selectmenu")),r=f.dropdown.market_submarkets,f.dropdown.display_submarkets?f.dropdown.display_submarkets.update_list(Object.keys(r[f.dropdown.display_markets.val()])):(f.dropdown.display_submarkets=l.default.makeSelectmenu((0,o.default)("<select />").insertAfter(_),{list:Object.keys(r[f.dropdown.display_markets.val()]),inx:0,changed:function(e){s(f.dropdown.display_markets.val(),f.dropdown.display_submarkets.val())},width:"200px"}),f.dropdown.display_submarkets.selectmenu("widget").addClass("asset-index-selectmenu")),s(f.dropdown.display_markets.val(),f.dropdown.display_submarkets.val());var r;var d,n}(e)}).catch(function(e){o.default.growl.error({message:e.message})})},w=function(e){e=(0,o.default)(e).i18n(),c=e.filter("table"),e.appendTo(_),n.default.bind(e[0],f),k(),require(["websockets/binary_websockets"],function(e){e.events.on("login",k),e.events.on("logout",k)})};e.default={init:m}});