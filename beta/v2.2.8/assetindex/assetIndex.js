define(["exports","jquery","../windows/windows","../websockets/binary_websockets","common/rivetsExtra","jquery-growl","css!./assetIndex.css"],function(a,b,c,d,e){"use strict";function f(a){return a&&a.__esModule?a:{"default":a}}function g(a){if(Array.isArray(a)){for(var b=0,c=Array(a.length);b<a.length;b++)c[b]=a[b];return c}return Array.from(a)}Object.defineProperty(a,"__esModule",{value:!0}),a.init=void 0;var h=f(b),i=f(c),j=f(d),k=f(e),l=null,m=null,n=null,o=null,p=a.init=function(a){a.click(function(){m?m.moveToTop():(m=i["default"].createBlankWindow(h["default"]("<div/>"),{title:"Asset Index".i18n(),dialogClass:"assetIndex",minWidth:800,minHeight:400}),m.track({module_id:"assetIndex",is_unique:!0,data:null}),m.dialog("open"),require(["text!assetindex/assetIndex.html"],u))})},q={dropdown:{display_markets:null,display_submarkets:null,is_volatility:!1,market_submarkets:null,selected_market:null},table:{asset_data:[],asset_data_extract:[],display_headers:[],display_asset_data:[],search_input:""},search:function(){function a(a){var b=q.table.search_input.toLowerCase();return-1!==a[0].toLowerCase().indexOf(b.toLowerCase())}return function(){q.table.display_asset_data=[],q.table.display_asset_data=q.table.asset_data_extract.filter(a),q.dropdown.is_volatility=r(q.dropdown.selected_market,q.dropdown.display_markets)}()}},r=function(a,b){var c=b[0][2]?b[0][2].innerText:b[0][0].innerText,d=-1!==a.indexOf(c);return d},s=function(a){var b=a.reduce(function(a,b){var c=b.market_display_name,d=b.submarket_display_name,e=b.display_name;return a[c]=a[c]||{},a[c][d]=a[c][d]||[],a[c][d].push(e),a},{});return b},t=function(){function a(a){function b(a,b){function c(a){return a.forEach(function(a){a.forEach(function(b){if(Array.isArray(b)){var c=b[0],d=b[1],e=q.table.display_headers.indexOf(c)+1;a[e]=d}})}),a}function d(a){for(var b=q.table.display_headers.length,c=function(b){a.forEach(function(a){(!a[b]||Array.isArray[a[b]])&&(a[b]="-")})},d=0;b>=d;d++)c(d);return a}var e=[].concat(g(q.dropdown.market_submarkets[a][b]));q.dropdown.selected_market=a,q.dropdown.is_volatility=r(a,q.dropdown.display_markets);var f=q.table.asset_data.filter(function(a){return e.indexOf(a[1])>-1}).map(function(a){var b=[],c=a[1],d=a[2];return q.table.display_headers=[],b.push(c),d.forEach(function(a){var c=a[1],d=a[2],e=a[3];q.table.display_headers.push(c),b.push([c,d+" - "+e])}),b});f=c(f),f=d(f),q.table.display_asset_data=f,q.table.asset_data_extract=f}function c(a){q.dropdown.display_markets?q.dropdown.display_markets.update_list(Object.keys(a)):(q.dropdown.display_markets=i["default"].makeSelectmenu(h["default"]("<select />").insertBefore(o),{list:Object.keys(a),inx:0,changed:function(c){var d=Object.keys(a[c]);q.dropdown.display_submarkets.update_list(d),b(q.dropdown.display_markets.val(),q.dropdown.display_submarkets.val())},width:"180px"}),q.dropdown.display_markets.selectmenu("widget").addClass("asset-index-selectmenu"))}function d(a){q.dropdown.display_submarkets?q.dropdown.display_submarkets.update_list(Object.keys(a[q.dropdown.display_markets.val()])):(q.dropdown.display_submarkets=i["default"].makeSelectmenu(h["default"]("<select />").insertBefore(o),{list:Object.keys(a[q.dropdown.display_markets.val()]),inx:0,changed:function(){b(q.dropdown.display_markets.val(),q.dropdown.display_submarkets.val())},width:"200px"}),q.dropdown.display_submarkets.selectmenu("widget").addClass("asset-index-selectmenu"))}var e=Object.assign(a[0].active_symbols),f=[].concat(g(a[1].asset_index));q.dropdown.market_submarkets=s(e),q.table.asset_data=f,n=m.parent().find(".ui-dialog-title").addClass("with-content"),o=m.parent().find(".ui-dialog-titlebar-buttonpane"),c(q.dropdown.market_submarkets),d(q.dropdown.market_submarkets),b(q.dropdown.display_markets.val(),q.dropdown.display_submarkets.val())}function b(){var a=h["default"]("#"+l.attr("id")+"_processing").show(),b={active_symbols:"brief"},c={asset_index:1};return Promise.all([j["default"].cached.send(b),j["default"].cached.send(c)]).then(function(b){return a.hide(),Promise.resolve(b)})["catch"](function(b){return a.hide(),Promise.reject(b)})}b().then(function(b){a(b)})["catch"](function(a){h["default"].growl.error({message:a.message})})},u=function(a){a=h["default"](a).i18n(),l=a.filter("table"),a.appendTo(m),k["default"].bind(a[0],q),t(),require(["websockets/binary_websockets"],function(a){a.events.on("login",t),a.events.on("logout",t)})};a["default"]={init:p}});