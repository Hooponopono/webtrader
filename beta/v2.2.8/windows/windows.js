define(["exports","jquery","lodash","navigation/navigation","windows/tracker","moment","../workspace/workspace.js","jquery.dialogextend","modernizr","common/util","css!windows/windows.css"],function(a,b,c,d,e,f,g){"use strict";function h(a){return a&&a.__esModule?a:{"default":a}}Object.defineProperty(a,"__esModule",{value:!0}),a.event_off=a.event_on=a.makeSelectmenu=a.createBlankWindow=a.init=void 0;{var i=h(b),j=h(c),k=(h(d),h(e)),l=h(f),m=h(g),n=0,o={},p=function(a){a=i["default"].extend({title:"title",date:null,changed:function(){},cleared:function(){},addDateDropDowns:!0},a);var b=this.parent().find(".ui-dialog-title").addClass("with-content"),c=function(c){var d=i["default"]("<input type='hidden' />").insertAfter(b),e={showOn:"both",numberOfMonths:1,maxDate:a.maxDate?a.maxDate:0,minDate:new Date(2010,0,1),dateFormat:"yy-mm-dd",showAnim:"drop",showButtonPanel:!0,changeMonth:!0,changeYear:!0,onSelect:function(){i["default"](this).change()},beforeShow:function(a,b){b.dpDiv.css({marginTop:"10px",marginLeft:"-220px"})},closeText:"Done".i18n(),currentText:"Today".i18n()},f=d.datepicker(e).datepicker("setDate",c.date.toISOString().slice(0,10));return i["default"].datepicker._gotoToday=function(a){i["default"](a).datepicker("setDate",new Date).change().datepicker("hide")},f.next("button").text("").button({icons:{primary:"ui-icon-calendar"}}),d.on("change",function(){var a=i["default"](this).val();c.onchange&&c.onchange(a)}),d},d=null,e=i["default"]('<span style="line-height: 24px; position: relative; left: 10px"></span>'),f=c({date:a.date||new Date,onchange:function(b){e.text(b),d&&d.update(b),a.changed(b)},onclear:function(){d&&d.clear(),a.cleared()}}),g=function(a){var c=i["default"]('<input placeholder="Select date" readonly class="windows-dateInput" />').insertAfter(b);return c.on("click",function(){return f.datepicker("show")}),a&&c.val(l["default"](a).format("DD MMM, YYYY")),{update:function(a){return c.val(l["default"].utc(a,"YYYY-MM-DD").format("DD MMM, YYYY"))},clear:function(){return c.val("")}}};return a.addDateDropDowns?d=g(a.date):(e.insertAfter(b),e.text(a.date.toISOString().slice(0,10))),i["default"]('<span class="span-in-dialog-header">'+a.title+"</span>").insertAfter(b),{clear:function(){return d&&d.clear()}}},q=function(){var a=i["default"](".addiction-warning").height(),b=i["default"](document).height()-i["default"](window).height()-i["default"](window).scrollTop();i["default"]("#dialog-extend-fixed-container").css("bottom",Math.max(0,a-b))},r=a.init=function(){var a=i["default"].fn.dialog;return i["default"].fn.dialog=function(b){return"destroy"===b?(this.trigger("dialogdestroy"),a.call(this,"destroy")):a.apply(this,arguments)},require(["charts/chartWindow","websockets/binary_websockets","navigation/menu","trade/tradeDialog"],function(a,b,c,d){return k["default"].is_empty()?void b.cached.send({trading_times:(new Date).toISOString().slice(0,10)}).then(function(e){e=c.extractChartableMarkets(e);var f=e[0].submarkets[0].instruments[0],g="1t",h="line",i="0.001";b.send({contracts_for:f.symbol}).then(function(b){a.addNewWindow({instrumentCode:f.symbol,instrumentName:f.display_name,timePeriod:g,type:h,delayAmount:f.delay_amount}),d.init({symbol:f.symbol,display_name:f.display_name,pip:i},b.contracts_for),m["default"].tileDialogs()})["catch"](function(a){return void 0})}):void k["default"].reopen()}),require(["websockets/binary_websockets"],function(a){if(local_storage.get("oauth")){var b=local_storage.get("oauth");Promise.all(b.slice(1).map(function(a){return{authorize:a.token}}).map(function(b){return a.send(b)})).then(function(b){return a.cached.authorize().then(function(a){var c=local_storage.get("oauth");b.forEach(function(a){if(a.authorize){var b=c.find(function(b){return b.id==a.authorize.loginid});b.currency=a.authorize.currency}}),local_storage.set("oauth",c),b.unshift(a);for(var d=!1,e=0;e<b.length;++e)c[e].id=b[e].authorize.loginid,c[e].is_virtual=b[e].authorize.is_virtual,-1!==b[e].authorize.landing_company_name.indexOf("japan")&&(d=!0);return local_storage.set("oauth",c),d})}).then(function(b){b&&b===!0&&(a.invalidate(),i["default"].growl.error({message:"Japan accounts are not supported.".i18n(),duration:6e3}),local_storage.remove("oauth"),local_storage.remove("oauth-login"))})["catch"](function(c){return"SelfExclusion"===c.code?void b.forEach(function(b){return b.id.match(/^VRTC/)?void a.switch_account(b.id):void 0}):(i["default"].growl.error({message:c.message}),local_storage.remove("oauth"),void i["default"](".login").trigger("login-error"))})}}),i["default"](window).scroll(q),this},s=a.createBlankWindow=function(a,b){a=i["default"](a);var c="windows-dialog-"+ ++n;b=i["default"].extend({autoOpen:!1,resizable:!0,collapsable:!1,draggable:!0,width:350,height:400,my:"center",at:"center",of:window,title:"Blank window".i18n(),icons:{close:"custom-icon-close",minimize:"custom-icon-minimize",maximize:"custom-icon-maximize",restore:"custom-icon-restore"}},b||{}),b.minWidth=b.minWidth||b.width,b.minHeight=b.minHeight||b.height,b.resize&&(b.maximize=b.minimize=b.restore=b.resize);var d=a.attr("id",c);b.ignoreTileAction||d.addClass("webtrader-dialog"),d.dialog(b).dialogExtend(b);var e=d.dialog("widget");e.addClass("webtrader-dialog-widget"),b.draggable!==!1&&(e.draggable("option","containment",!1),e.draggable("option","scroll",!0)),e.on("dragstop",function(){var a=e.offset().top;0>a&&e.animate({top:"0px"},300,e.trigger.bind(e,"animated"))}),b.destroy&&d.on("dialogdestroy",b.destroy),d.on("dialogopen",function(){var a=this;j["default"].defer(function(){var b=["#msg-notification","#topbar","#nav-menu"].map(function(a){return i["default"](a).outerHeight()}).reduce(function(a,b){return a+b},0),c=i["default"](a).parent();1*c.css("top").replace("px","")<=b&&c.animate({top:b+(15*Math.random()|0),left:"+="+((10*Math.random()|0)-20)+"px"},300,e.trigger.bind(e,"animated"))})}),d.moveToTop=function(){d.dialog("open"),d.dialogExtend("restore"),d.dialog("widget").effect("bounce",{times:2,distance:15},450)};var f=function(){var a=m["default"].addDialog(b.title,d.moveToTop,function(){return d.dialog("close")});d.on("dialogclose",a)};b.ignoreTileAction||f(),b.resize&&b.resize.call(a[0]),d.addDateToHeader=p;var g=Object.keys(b).filter(function(a){return j["default"].startsWith(a,"data-")});if(g.forEach(function(a){return d.attr(a,b[a])}),b.refresh){var h=d.parent().find(".ui-dialog-title"),l=h.append("<img class='reload' src='images/refresh.svg' title='reload'/>").find(".reload");l.on("click",b.refresh)}return d.track=function(a){return k["default"].track(a,d)},d.destroy=function(){d.data("ui-dialog")&&d.dialog("destroy"),d.remove()},d},t=a.makeSelectmenu=function(a,b){b=i["default"].extend({list:["empty"],inx:0,changed:function(){}},b),b.changed=b.changed?b.changed:function(){};var c=b.inx,d=b.list,e=function(b){a.children().remove();for(var c=0;c<b.length;++c)i["default"]("<option/>").val(b[c]).text(b[c]).appendTo(a)};return e(d),a.val(d[c]),a=a.selectmenu({classes:{"ui-selectmenu-button":"ui-selectmenu-button ui-state-default"},width:b.width}),a.on("selectmenuchange",function(){var a=i["default"](this).val();b.changed(a)}),a.update_list=function(b){e(b),a.val(b[0]),a.selectmenu("refresh")},a};a.event_on=function(a,b){return(o[a]=o[a]||[]).push(b),b},a.event_off=function(a,b){if(o[a]){var c=o[a].indexOf(b);-1!==c&&o[a].splice(c,1)}}}a["default"]={init:r,createBlankWindow:s,makeSelectmenu:t}});